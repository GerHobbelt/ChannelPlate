<html>
<head>
<script src="../ChannelPlate.js"></script>
<script src="../iframe.js"></script>
</head>
<body>
<p>Open the DEBUGging console to see the conversation logged</p>
<!-- define the iframe with blank content -->
<iframe class='ChannelPlateChild' src="about:blank"></iframe>
<iframe class='ChannelPlateClient' src="about:blank"></iframe>
</body>
<script>
// Google BSD license http://code.google.com/google_bsd_license.html
// Copyright 2011 Google Inc. johnjbarton@google.com

var DEBUG = false;
var TIME_LIMIT = 1000;

function output(msg) {
    var div = document.createElement('div');
    div.textContent = msg;
    document.body.appendChild(div);
    console.log(msg);
}

function tookTooLong() {
    output('FAIL: child did not respond within ' + TIME_LIMIT + ' millisecs.');
}

var timeoutId = setTimeout(tookTooLong, TIME_LIMIT);

// The iframe can be an HTML element or created by DOM calls
var childFrame = document.querySelector('.ChannelPlateChild');

// After we listen for messages we navigate the frame.

ChannelPlate.iframe.connect(childFrame, "childFrame.html", function(iframeMessagePort) {
    // Low-level incoming API tests connection
    //
    iframeMessagePort.onMessage.addListener(function onMessage(message) {
        if (message === 'mommy?') {
            output("PASS: parent hears")
        } else {
            output('FAIL: ' + window.location +  ' heard: \"' + message + '\"');
        }
        clearTimeout(timeoutId);
        nextTest();
    });

    // Low-level outgoing API test
    iframeMessagePort.postMessage('hello child');
});

if (DEBUG) {
  output("parent listening for child");
}


function nextTest() {
    //---------- Test RMC -----------------------------------------------

    var clientFrame = document.querySelector('.ChannelPlateClient');

    var serverTestMethods = {
        add: function(lhs, rhs, callback, errback) {
            callback(lhs + rhs);
        },
        div: function(lhs, rhs, callback, errback){
            if (rhs === 0) {
                errback("divide by zero");
            } else {
                callback(lhs/rhs);
            }
        }
    }

    ChannelPlate.iframe.startServer(clientFrame, "clientFrame.html", serverTestMethods);
}


</script>
</html>
