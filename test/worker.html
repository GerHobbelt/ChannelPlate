<html>
<head>
<script src="../ChannelPlate.js"></script>
<script src="../ChannelPlateConnectedWorker.js"></script>
<script src="../RemoteMethodCall.js"></script>
<script src="../ChannelPlateServerWorker.js"></script>
</head>
<body>
<p>Open the DEBUGging console to see the conversation logged</p>
</body>
<script>
// Google BSD license http://code.google.com/google_bsd_license.html
// Copyright 2013 Google Inc. johnjbarton@google.com

var DEBUG = false;
var TIME_LIMIT = 1000;

function tookTooLong() {
    console.log('FAIL: child did not respond within ' + TIME_LIMIT + ' millisecs.');
}

var timeoutId = setTimeout(tookTooLong, TIME_LIMIT);

// Low-level incoming API tests connection
//
function onMessage(message) {
    if (message === 'mommy?') {
        console.log("PASS: parent hears")
    } else {
        console.log('FAIL: ' + window.location +  ' heard: \"' + message + '\"');
    }
    clearTimeout(timeoutId);
    testRPC();
}

// After we listen for messages we create the worker

ChannelPlate.ConnectedWorker("testWorker.js", function(rawPort){
    var portToChild = new ChannelPlate.Base(rawPort, onMessage);
    // Low-level outgoing API call starts test
    //
    portToChild.postMessage ("hello child");
});

if (DEBUG) {
  console.log("parent listening for child");
}

function testRPC() {
    
    // A web page acting as a server for an iframe
    var serverTestMethods = {
        add: function(lhs, rhs, callback, errback) {
            callback(lhs + rhs);
        },
        div: function(lhs, rhs, callback, errback){
            if (rhs === 0) {
                errback("divide by zero");
            } else {
                callback(lhs/rhs);
            }
        },
        terminate: function(callback, errback) {
            callback();
            testServerWorker();
        }
    }

    var worker = new ChannelPlate.ConnectedWorker("testWorkerRPC.js", function(rawPort){
        var server = new RemoteMethodCall.Responder(serverTestMethods, rawPort);
    });

    // A worker acting as a server for a web page.
    function testServerWorker() {
      var TIME_LIMIT = 1000;

      function tookTooLong() {
	    console.log('FAIL: server did not respond within ' + TIME_LIMIT + ' millisecs.')
      }

      var timeoutId = setTimeout(tookTooLong, TIME_LIMIT);
      
      var serverAPI = {
        add: function(lhs, rhs, resultsBack, errBack){},
	    div: function(lhs, rhs, resultsBack, errBack){},
	    terminate: function(lhs, rhs, resultsBack, errBack){}
      }
      var worker = new ChannelPlate.ServerWorker("testWorkerServer.js", serverAPI);
      var proxy = worker.serverProxy();
      proxy.add(2,2, function(result){
	   if (result === 4) {
		console.log('PASS: ' + result);
	   } else {
		console.log('FAIL: ' + result)
	   }
	   proxy.div(2,0,
		function(result){
			console.log('FAIL: ' + result);
			clearTimeout(timeoutId);
		},
		function (err) {
			console.log('PASS: ' + err);
			proxy.terminate(function(){
				console.log('PASS terminate');
			}, function() {
				console.log('FAIL terminate');
			});
			clearTimeout(timeoutId);
		}
	);
});
    }
}





</script>
</html>