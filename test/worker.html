<html>
<head>
<script src="../ChannelPlate.js"></script>
<script src="../worker.js"></script>
</head>
<body>
<p>Open the DEBUGging console to see the conversation logged</p>
</body>
<script>
// Google BSD license http://code.google.com/google_bsd_license.html
// Copyright 2013 Google Inc. johnjbarton@google.com

var DEBUG = false;
var TIME_LIMIT = 1000;

function output(msg) {
    var div = document.createElement('div');
    div.textContent = msg;
    document.body.appendChild(div);
    console.log(msg);
}

function tookTooLong() {
    output('FAIL: child did not respond within ' + TIME_LIMIT + ' millisecs.');
    throw new Error("TIME_LIMIT")
}

var timeoutId = setTimeout(tookTooLong, TIME_LIMIT);


// After we listen for messages we create the worker
var worker = new Worker("testWorker.js");
ChannelPlate.worker.connect(worker, function(workerMessagePort){

  workerMessagePort.onMessage.addListener(function onMessage(message) {
    // Low-level incoming API tests connection
    if (message === 'mommy?') {
        output("PASS: parent hears " + message)
    } else {
        output('FAIL: ' + window.location +  ' heard: \"' + message + '\"');
    }
    clearTimeout(timeoutId);
    testServerWorker();
  });
  // Low-level outgoing API call starts test
  //
  workerMessagePort.postMessage ("hello child");
});

// A worker acting as a server for a web page.
function testServerWorker() {
  var TIME_LIMIT = 1000;

  function tookTooLong() {
    output('FAIL: server did not respond within ' + TIME_LIMIT + ' millisecs.')
  }

  var timeoutId = setTimeout(tookTooLong, TIME_LIMIT);

  var serverAPI = {
    add: function(lhs, rhs, resultsBack, errBack){},
    div: function(lhs, rhs, resultsBack, errBack){},
    terminate: function(lhs, rhs, resultsBack, errBack){}
  };

  var workerServer = new Worker("testWorkerServer.js");

  ChannelPlate.worker.startClient(workerServer, serverAPI, function(serverProxy) {
    output("WorkerServer client ready");
    serverProxy.add(2,2, checkAdd);
    function checkAdd(result){
      if (result === 4) {
        output('PASS: ' + result);
      } else {
        output('FAIL: ' + result)
      }
    }
    serverProxy.div(2, 0, checkDiv, errDiv);

    function checkDiv(result){
      output('FAIL: ' + result);
      clearTimeout(timeoutId);
    }
    function errDiv(err) {
      output('PASS: ' + err);
      serverProxy.terminate(function(){
        output('PASS terminate');
      }, function() {
        output('FAIL terminate');
      });
      workerServer.terminate();
      clearTimeout(timeoutId);
    }
  });
}
</script>
</html>
